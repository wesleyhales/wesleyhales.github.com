<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" prefix="og: http://ogp.me/ns#" xmlns:og="http://ogp.me/ns#"><!--<![endif]-->

    <head>
                <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="author" content="">
        <meta name="keywords" content="awesome, definitely">
	
        <meta property="og:site_name" content="Wesley Hales">
        <meta property="og:title" content="Wesley Hales">
        <meta property="og:url" content="http://wesleyhales.com:1313/blog/2011/08/29/Fixing-Ajax-on-Mobile-Devices-with-HTML5">
        <meta property="og:description" content="">
    
        <meta property="og:type" content="article" />
        <meta property="og:article:author" content="" />
        <meta property="og:article:published_time" content="2011-08-29T00:00:00Z" />
    
        <meta name="generator" content="Hugo 0.16" />
        <title>Fixing Ajax on Mobile Devices (with HTML5) &middot; Wesley Hales </title>
        <link rel="canonical" href="http://wesleyhales.com:1313/" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="">
        <link rel="stylesheet" type='text/css' href="http://wesleyhales.com:1313/css/main.css"/>
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300|Montserrat:700' rel='stylesheet' type='text/css'>
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
        <script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
    </head>
<body>
<!--[if lt IE 7]><p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chrome/â€Ž">install Google Chrome</a> to experience this site.</p><![endif]-->

    <header id="site-header">
        <div class="container">
            <a href="http://wesleyhales.com:1313/" alt="Wesley Hales"><h1 class="blog-title heading">Wesley Hales</h1></a>
            <p class="blog-description"></p>
        </div>
    </header>
<main class="content" role="main">
	<div class="container">
		<article class="old">
	<header class="post-header">
        <h3 class="p-post-title">Fixing Ajax on Mobile Devices (with HTML5)</h3>
    </header>

    <section class="post-content">
        <p><strong>Update: <a href="https://twitter.com/#!/_boye/">@_boye</a> has created <a href="http://jsperf.com/ajax-response-handling-innerhtml-vs-sandboxed-iframe">a perf test which shows the performance of this solution</a>. Remarkably, This iFrame solution outperforms innerHTML on Firefox 7 and maintains the same speed on Chrome 16.</strong></p>
<p>The most common approach for receiving markup from an Ajax request is to use innerHTML for placement of the responseText. This method has been widely used (and argued) since the inception of XHR, but it surprises me that it's still being recommended and used not only on desktop browsers but mobile ones as well.</p>
<p>3 or 4 years have passed since many folks raised their concerns with innerHTML:</p>
<p>From Javascript The Good Parts:</p>
<p>&ldquo;If the HTML text contains a &lt;script&gt; tag or its equivalent, then an evil script will run. .. This danger is a direct consequence of JavaScript&rsquo;s global object which is far and away the worst part of JavaScript&rsquo;s many bad parts.&rdquo;</p>
<p>Not only is innerHTML bad, it is the root cause of many problems... from <a href="http://www.julienlecomte.net/blog/2007/12/38/">browser memory leaks</a> (it destroys/replaces existing elements that may have event handlers attached) to <a href="http://martinkou.blogspot.com/2011/05/alternative-workaround-for-mobile.html">failing completely</a> on iOS&rsquo;s Mobile Safari. Yes, that's right, it just flakes out.</p>
<p>So even if you use <a href="http://javascript.crockford.com/memory/leak.html">Crockford&rsquo;s purge</a> method to fix the memory leaks and sanitize your response string returned from the server, you still have a showstopping flaw when running any mobile web solution that uses innerHTML on iOS devices </p>

<p>Just to name a few mobile frameworks that use this flawed innerHTML approach:</p>
<p><a href="http://api.jquery.com/html/">JQuery Mobile</a> (uses jQuery&rsquo;s .html() wich is a wrapper for innerHTML)</p>
<p><a class="active_link" href="http://wiki.phonegap.com/w/page/42450600/PhoneGap%20Ajax%20Sample">Phone Gap</a></p>
<p><a href="http://www.sencha.com/forum/showthread.php?122591-List-rendering-race-condition">Sencha</a></p>

<p><strong>A possible solution:</strong></p>
<p>We all know that innerHTML is a favorite for it&rsquo;s speed and ease of use but speed doesn&rsquo;t really matter when it doesn&rsquo;t work at all. So one solution is through use of some new features in HTML5 and the DOM api:</p>

<p>Let's start with the scenario that you've made your XHR and received the responseText. </p>
<p>First thing we'll do is create a temporary iFrame element. This isn't any ordinary iframe, it received a major security enhancement with HTML5 and we have some new sanitizing features with the "sandbox" attribute. </p>

<p>From the <a href="http://dev.w3.org/html5/spec-author-view/the-iframe-element.html#attr-iframe-sandbox">spec</a>:</p>
<p><span style="color: #808080;">The sandbox attribute, when specified, enables a set of extra restrictions on any content hosted by the iframe. Its value must be an unordered set of unique space-separated tokens that are ASCII case-insensitive. The allowed values are allow-forms, allow-same-origin, allow-scripts, and allow-top-navigation. When the attribute is set, the content is treated as being from a unique origin, forms and scripts are disabled, links are prevented from targeting other browsing contexts, and plugins are disabled. </span></p>
<p><span style="color: #ff0000;">To limit the damage that can be caused by hostile HTML content, it should be served using the <strong>text/html-sandboxed</strong> MIME type.</span></p>

<pre class="jive_text_macro jive_macro_code" jivemacro="code" ___default_attr="java"><p>function getFrame() {</p><p>    var frame = document.getElementById("temp-frame");</p><p>    if (!frame) {</p><p>        // create frame</p><p>        frame = document.createElement("iframe");</p><p>        frame.setAttribute("id", "temp-frame");</p><p>        frame.setAttribute("name", "temp-frame");</p><p>        frame.setAttribute("seamless", "");</p><p>        frame.setAttribute("sandbox", "");</p><p>        frame.style.display = 'none';</p><p>        document.documentElement.appendChild(frame);</p><p>    }</p><p>    return frame.contentDocument;</p><p>}</p></pre>

<p>Now, we get our ajax response and write it to the iframe:</p>

<pre class="jive_text_macro jive_macro_code" jivemacro="code" ___default_attr="java"><p>var frame = getFrame();</p><p>frame.write(responseText);</p></pre>

<p>The beauty of this solution is the fact that we don't have to deal with a <a href="http://ejohn.org/blog/pure-javascript-html-parser">javascript text to DOM parser</a>. We're allowing the browser to do what it does best... parse the HTML and build a DOM. And we don't have to worry about parsing the response and removing a blacklist of prohibited security risk elements and other XSS hacking pitas.</p>

<p>After writing the response to the iframe, you now have a ready to use sanitized DOM. Next you can use the DOM API to grab any part of the new document.</p>

<pre class="jive_text_macro jive_macro_code" jivemacro="code" ___default_attr="java"><p> var incomingElements = frame.getElementsByClassName('elementClassName');</p></pre>

<p>Safari correctly refuses to implicitly move a node from one document to another. An error is raised if the new child node was created in a different document. So here we use adoptNode to add the incomingElements to our existing page.</p>

<pre class="jive_text_macro jive_macro_code" jivemacro="code" ___default_attr="java"><p> document.getElementById(elementId).appendChild(document.adoptNode(incomingElements));</p></pre>

<p>The only thing left to do now is benchmarking. As I said earlier, working with the DOM has been notably slower than using innerHTML in the past. So there may be a derivative of this proposed solution that is faster? or there may not be a huge difference in execution time? Let me know....</p>

    </section>

    <hr>

    <footer class="post-footer">
        <section class="f-1">
            
            <section class="author">
                <p>Words by Wesley Hales</p>
            </section>
            
            
            <p class="f-post-time"><time datetime="2011-08-29T00:00:00Z">August 29, 2011</time></p>
        </section>
                        
        <section class="f-2">
            <section class="share">
                <span>Share:
                <a class="icon-twitter" href="http://twitter.com/share?text=Fixing%20Ajax%20on%20Mobile%20Devices%20%28with%20HTML5%29&url=http%3a%2f%2fwesleyhales.com%3a1313%2fblog%2f2011%2f08%2f29%2fFixing-Ajax-on-Mobile-Devices-with-HTML5"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="fa fa-twitter"></i>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fwesleyhales.com%3a1313%2fblog%2f2011%2f08%2f29%2fFixing-Ajax-on-Mobile-Devices-with-HTML5"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="fa fa-facebook"></i>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http%3a%2f%2fwesleyhales.com%3a1313%2fblog%2f2011%2f08%2f29%2fFixing-Ajax-on-Mobile-Devices-with-HTML5"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="fa fa-google-plus"></i>
                </a>
                </span>
            </section>

            
            	<span class="f-post-tags"><i class="fa fa-tag"></i>
            	Java, ajax, html5, innerhtml
            	</span>
            
        </section>
                
        <section id="comments">
            <div id="disqus_thread" class="post-comments"></div>
            <script type="text/javascript">
              if (window.location.hostname != "localhost") {
                var disqus_shortname = 'wesleyhales';
                (function() {
                  var dsq = document.createElement('script');
                  dsq.type = 'text/javascript';
                  dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              }
            </script>
            <noscript>
              Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
            </noscript>
        </section>
                
    </footer>
</article>
	</div>
</main>
    <footer id="site-footer">
        <div class="container">
            <a href="http://wesleyhales.com:1313/index.xml" title="Get the RSS feed"><span class="tooltip"><i class="fa fa-rss"></i></span></a>
            <section>&copy; Wesley Hales 2016 | All rights reserved</section>
        </div>
    </footer>

    <script type="text/javascript" src="http://wesleyhales.com:1313/js/fittext.js"></script>
    <script type="text/javascript">
      $(".heading").fitText();
    </script>

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-1241000-10', 'auto');
        ga('send', 'pageview');

    </script>


<script data-no-instant>document.write('<script src="/livereload.js?mindelay=10"></' + 'script>')</script></body>
</html>